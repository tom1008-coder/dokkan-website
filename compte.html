<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Dokkan Dex</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="compte.css">
</head>
<body class="bg-dark">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-warning sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-warning d-flex align-items-center" href="index.html">
                <img src="assets/logo.png" alt="Logo" width="40" height="40" class="me-2">
                DOKKAN DEX
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Toutes les Cartes</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">√âv√©nements</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">√Ä Propos</a></li>
                </ul>
                <div class="d-flex ms-lg-3 align-items-center">
                    <a id="nav-login-btn" href="auth.html" class="btn btn-outline-warning btn-sm d-none">Connexion</a>
                    <div id="nav-user-menu" class="dropdown d-none">
                        <button class="btn btn-warning btn-sm dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                            <span id="nav-user-email">Mon Compte</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark border-secondary">
                            <li><a class="dropdown-item active" href="compte.html">Profil & Infos</a></li>
                            <li><hr class="dropdown-divider border-secondary"></li>
                            <li><button id="nav-logout-btn" class="dropdown-item text-danger">D√©connexion</button></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 mb-5 flex-grow-1">
        
        <div id="alert-area"></div>

        <div id="loading-profile" class="text-center py-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-2 text-white">Chargement du profil...</p>
        </div>

        <div id="profile-content" class="row justify-content-center d-none">
            <div class="col-lg-8">
                
                <div class="card profile-card mb-4">
                    <div class="card-header border-bottom border-secondary bg-secondary bg-opacity-25 py-3">
                        <h4 class="mb-0 text-warning fw-bold">üë§ MON PROFIL</h4>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label class="text-secondary text-uppercase small fw-bold mb-1">Pseudonyme actuel</label>
                            <div class="fs-4 fw-bold" id="display-pseudo">Invit√©</div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="text-secondary text-uppercase small fw-bold mb-1">Email</label>
                                <p id="user-email-display" class="mb-0">...</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-secondary text-uppercase small fw-bold mb-1">Membre depuis le</label>
                                <p id="user-date-display" class="mb-0">...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card profile-card mb-4">
                    <div class="card-header border-bottom border-secondary bg-secondary bg-opacity-25 py-3">
                        <h5 class="mb-0 text-info fw-bold">üõ†Ô∏è PARAM√àTRES DU COMPTE</h5>
                    </div>
                    <div class="card-body p-4">
                        
                        <form id="form-pseudo" class="mb-4 border-bottom border-secondary pb-4">
                            <label class="form-label text-warning fw-bold">Changer mon Pseudonyme</label>
                            <div class="input-group">
                                <input type="text" id="input-pseudo" class="form-control" placeholder="Entrez votre nouveau pseudo">
                                <button class="btn btn-outline-warning" type="submit">Sauvegarder</button>
                            </div>
                            <div class="form-text text-white">Ce nom sera affich√© dans la barre de navigation.</div>
                        </form>

                        <form id="form-password">
                            <label class="form-label text-danger fw-bold">Changer mon Mot de Passe</label>
                            <div class="mb-2">
                                <input type="password" id="input-password" class="form-control" placeholder="Nouveau mot de passe (6 carac. min)">
                            </div>
                            <div class="mb-3">
                                <input type="password" id="input-password-confirm" class="form-control" placeholder="Confirmer le mot de passe">
                            </div>
                            <button type="submit" class="btn btn-outline-danger w-100">Mettre √† jour le mot de passe</button>
                        </form>

                    </div>
                </div>

                <h5 class="mb-3 ps-1 border-start border-4 border-warning ps-2 mt-5">MES STATISTIQUES</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="p-3 rounded stat-card text-center h-100 d-flex flex-column justify-content-center">
                            <div class="display-6 fw-bold text-warning" id="stat-box-count">0</div>
                            <div class="text-white small text-uppercase mt-2">Cartes dans la Box</div>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-secondary disabled">Voir ma Box</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 rounded stat-card text-center h-100 d-flex flex-column justify-content-center">
                            <div class="display-6 fw-bold text-info" id="stat-team-count">0</div>
                            <div class="text-white small text-uppercase mt-2">√âquipes cr√©√©es</div>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-secondary disabled">Voir mes √âquipes</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer class="bg-dark text-light border-top border-secondary py-4 mt-auto">
        <div class="container text-center">
            <span class="text-warning fw-bold">DOKKAN DEX</span><br>
            <small class="text-muted">¬© 2025 - Outil Fan-Made</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="navbar.js"></script>

    <script>
        // Fonction utilitaire pour afficher les alertes
        function showAlert(msg, type) {
            const alertArea = document.getElementById('alert-area');
            alertArea.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${msg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. V√©rification Session
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = 'auth.html';
                return;
            }

            const user = session.user;
            
            // 2. Remplissage Infos
            document.getElementById('user-email-display').textContent = user.email;
            
            const dateCreation = new Date(user.created_at);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('user-date-display').textContent = dateCreation.toLocaleDateString('fr-FR', options);

            // 3. Gestion Pseudo
            const currentPseudo = user.user_metadata.display_name || "Non d√©fini";
            document.getElementById('display-pseudo').textContent = currentPseudo;
            if(user.user_metadata.display_name) {
                document.getElementById('input-pseudo').value = user.user_metadata.display_name;
            }

            // 4. Affichage
            document.getElementById('loading-profile').classList.add('d-none');
            document.getElementById('profile-content').classList.remove('d-none');

            // --- Logique Modification Pseudo ---
            document.getElementById('form-pseudo').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPseudo = document.getElementById('input-pseudo').value.trim();

                if (!newPseudo) return showAlert("Le pseudo ne peut pas √™tre vide.", "warning");

                const { data, error } = await supabase.auth.updateUser({
                    data: { display_name: newPseudo }
                });

                if (error) {
                    showAlert("Erreur : " + error.message, "danger");
                } else {
                    showAlert("Pseudonyme mis √† jour !", "success");
                    document.getElementById('display-pseudo').textContent = newPseudo;
                    setTimeout(() => location.reload(), 1000); 
                }
            });

            // --- Logique Modification Mot de Passe ---
            document.getElementById('form-password').addEventListener('submit', async (e) => {
                e.preventDefault();
                const pass1 = document.getElementById('input-password').value;
                const pass2 = document.getElementById('input-password-confirm').value;

                if (pass1.length < 6) return showAlert("6 caract√®res minimum.", "warning");
                if (pass1 !== pass2) return showAlert("Les mots de passe ne correspondent pas.", "danger");

                const { data, error } = await supabase.auth.updateUser({
                    password: pass1
                });

                if (error) {
                    showAlert("Erreur : " + error.message, "danger");
                } else {
                    showAlert("Mot de passe modifi√© avec succ√®s !", "success");
                    document.getElementById('form-password').reset();
                }
            });
        });
    </script>
</body>
</html>